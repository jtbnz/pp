#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * Puke Portal - Artisan CLI
 *
 * Command dispatcher for CLI tools.
 *
 * Usage:
 *   php artisan <command> [options]
 *
 * Available Commands:
 *   admin:create       Create an admin or member user
 *   trainings:generate Generate training night events
 *   session:clear      Clean expired sessions and rate limits
 *   cache:clear        Clear application caches
 *   fix:dlb-emails     Fix placeholder emails from DLB import
 *   help               Show this help message
 *   list               List all available commands
 */

// Ensure we're running from CLI
if (PHP_SAPI !== 'cli') {
    die('This script must be run from the command line.');
}

// Set timezone
date_default_timezone_set('Pacific/Auckland');

// Error reporting for CLI
error_reporting(E_ALL);
ini_set('display_errors', '1');

// Define root path
define('ROOT_PATH', __DIR__);

// Load Composer autoloader
require_once ROOT_PATH . '/vendor/autoload.php';

use Portal\Commands\AdminCreate;
use Portal\Commands\TrainingsGenerate;
use Portal\Commands\SessionCleanup;
use Portal\Commands\CacheClear;
use Portal\Commands\FixDlbEmails;

// Colors for terminal output
class ConsoleColors
{
    public const RED = "\033[0;31m";
    public const GREEN = "\033[0;32m";
    public const YELLOW = "\033[1;33m";
    public const BLUE = "\033[0;34m";
    public const NC = "\033[0m";
}

/**
 * Print colored output
 */
function output(string $message, string $color = ''): void
{
    echo $color . $message . ConsoleColors::NC . PHP_EOL;
}

/**
 * Print application header
 */
function printHeader(): void
{
    output('');
    output('Puke Portal CLI', ConsoleColors::BLUE);
    output('================', ConsoleColors::BLUE);
    output('');
}

/**
 * Print help message
 */
function printHelp(): void
{
    printHeader();

    echo <<<HELP
Usage: php artisan <command> [options]

Available Commands:
  admin:create         Create an admin or member user
  trainings:generate   Generate training night events
  session:clear        Clean expired sessions and rate limits
  cache:clear          Clear application caches
  fix:dlb-emails       Fix placeholder emails from DLB import
  help                 Show this help message
  list                 List all available commands

Options:
  -h, --help           Show command help

Examples:
  php artisan admin:create --email=admin@example.com --name="John Smith"
  php artisan trainings:generate --months=12
  php artisan session:clear
  php artisan cache:clear

For command-specific help:
  php artisan <command> --help

HELP;
}

/**
 * List all commands with descriptions
 */
function listCommands(): void
{
    printHeader();

    $commands = [
        'admin:create' => 'Create an admin or member user',
        'trainings:generate' => 'Generate training night events',
        'session:clear' => 'Clean expired sessions and rate limits',
        'cache:clear' => 'Clear application caches',
        'fix:dlb-emails' => 'Fix placeholder emails from DLB import',
    ];

    output('Available Commands:', ConsoleColors::YELLOW);
    output('');

    foreach ($commands as $command => $description) {
        $padding = str_repeat(' ', 25 - strlen($command));
        echo "  " . ConsoleColors::GREEN . $command . ConsoleColors::NC . $padding . $description . PHP_EOL;
    }

    output('');
    output('Run "php artisan <command> --help" for command-specific help.');
    output('');
}

/**
 * Load configuration
 */
function loadConfig(): array
{
    $configFile = ROOT_PATH . '/config/config.php';

    if (!file_exists($configFile)) {
        $configFile = ROOT_PATH . '/config/config.example.php';
    }

    if (!file_exists($configFile)) {
        output('Error: Configuration file not found.', ConsoleColors::RED);
        exit(1);
    }

    return require $configFile;
}

/**
 * Initialize database connection
 */
function initDatabase(array $config): PDO
{
    $dbPath = $config['database_path'] ?? ROOT_PATH . '/data/portal.db';
    $dbDir = dirname($dbPath);

    // Ensure directory exists
    if (!is_dir($dbDir)) {
        mkdir($dbDir, 0755, true);
    }

    try {
        $db = new PDO('sqlite:' . $dbPath);
        $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        $db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        $db->exec('PRAGMA foreign_keys = ON');
        $db->exec('PRAGMA journal_mode = WAL');
        return $db;
    } catch (PDOException $e) {
        output('Database error: ' . $e->getMessage(), ConsoleColors::RED);
        exit(1);
    }
}

/**
 * Initialize database schema if needed
 */
function initSchema(PDO $db): void
{
    $tables = $db->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(PDO::FETCH_COLUMN);

    if (empty($tables)) {
        $schemaFile = ROOT_PATH . '/data/schema.sql';
        if (file_exists($schemaFile)) {
            $schema = file_get_contents($schemaFile);
            $db->exec($schema);
        }
    }
}

/**
 * Command mapping
 */
function getCommandClass(string $command): ?string
{
    $commandMap = [
        'admin:create' => AdminCreate::class,
        'trainings:generate' => TrainingsGenerate::class,
        'session:clear' => SessionCleanup::class,
        'cache:clear' => CacheClear::class,
        'fix:dlb-emails' => FixDlbEmails::class,
    ];

    return $commandMap[$command] ?? null;
}

// ============================================================================
// Main execution
// ============================================================================

// Get command from arguments
$args = $argv;
array_shift($args); // Remove script name

if (empty($args)) {
    printHelp();
    exit(0);
}

$command = array_shift($args);

// Handle built-in commands
switch ($command) {
    case 'help':
    case '--help':
    case '-h':
        printHelp();
        exit(0);

    case 'list':
        listCommands();
        exit(0);
}

// Check for command help
if (in_array('--help', $args, true) || in_array('-h', $args, true)) {
    $commandClass = getCommandClass($command);

    if ($commandClass && class_exists($commandClass) && method_exists($commandClass, 'getUsage')) {
        printHeader();
        echo $commandClass::getUsage() . PHP_EOL;
        exit(0);
    }

    output("Unknown command: {$command}", ConsoleColors::RED);
    output('Run "php artisan list" to see available commands.');
    exit(1);
}

// Get command class (autoloaded via Composer)
$commandClass = getCommandClass($command);

if (!$commandClass) {
    output("Unknown command: {$command}", ConsoleColors::RED);
    output('Run "php artisan list" to see available commands.');
    exit(1);
}

if (!class_exists($commandClass)) {
    output("Command class not found: {$commandClass}", ConsoleColors::RED);
    exit(1);
}

// Initialize application
$config = loadConfig();
$db = initDatabase($config);
initSchema($db);

// Execute command
try {
    $instance = new $commandClass($db, $config);
    $exitCode = $instance->execute($args);
    exit($exitCode);
} catch (Throwable $e) {
    output('Error: ' . $e->getMessage(), ConsoleColors::RED);
    if ($config['debug'] ?? false) {
        output('');
        output('Stack trace:');
        output($e->getTraceAsString());
    }
    exit(1);
}
