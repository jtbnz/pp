# Puke Portal - Apache Virtual Host Configuration
#
# This configuration is for portal.kiaora.tech with SSL via Let's Encrypt.
#
# Installation:
#   1. Copy this file to /etc/apache2/sites-available/portal.kiaora.tech.conf
#   2. Enable the site: sudo a2ensite portal.kiaora.tech.conf
#   3. Test configuration: sudo apache2ctl configtest
#   4. Reload Apache: sudo systemctl reload apache2
#
# Prerequisites:
#   - sudo a2enmod rewrite ssl headers expires
#   - SSL certificates from Let's Encrypt (see certbot instructions)

# ============================================================================
# HTTP - Redirect to HTTPS
# ============================================================================

<VirtualHost *:80>
    ServerName portal.kiaora.tech
    ServerAlias www.portal.kiaora.tech

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Let's Encrypt challenge directory (for certificate renewal)
    Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
    <Directory "/var/www/html/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>

# ============================================================================
# HTTPS - Main Configuration
# ============================================================================

<VirtualHost *:443>
    ServerName portal.kiaora.tech
    ServerAlias www.portal.kiaora.tech
    ServerAdmin admin@kiaora.tech

    # Document root - point to the public directory
    DocumentRoot /var/www/portal/public

    # Directory configuration
    <Directory /var/www/portal/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Enable URL rewriting for clean URLs
        RewriteEngine On

        # Handle Authorization Header
        RewriteCond %{HTTP:Authorization} .
        RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

        # Redirect Trailing Slashes
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)/$ /$1 [L,R=301]

        # Send Requests To Front Controller
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^ index.php [L]
    </Directory>

    # =========================================================================
    # SSL Configuration (Let's Encrypt)
    # =========================================================================

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/portal.kiaora.tech/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/portal.kiaora.tech/privkey.pem

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # =========================================================================
    # Security Headers
    # =========================================================================

    <IfModule mod_headers.c>
        # HTTP Strict Transport Security (HSTS)
        # Forces browsers to use HTTPS for 1 year
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Content Security Policy (CSP)
        # Adjust as needed for your application
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' https://kiaora.tech; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"

        # Prevent MIME type sniffing
        Header always set X-Content-Type-Options "nosniff"

        # XSS Protection (legacy, but doesn't hurt)
        Header always set X-XSS-Protection "1; mode=block"

        # Clickjacking protection
        Header always set X-Frame-Options "DENY"

        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Permissions Policy
        Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(self), payment=()"

        # Remove server signature
        Header always unset Server
        Header always unset X-Powered-By
    </IfModule>

    # =========================================================================
    # Cache Headers for Static Assets
    # =========================================================================

    <IfModule mod_expires.c>
        ExpiresActive On

        # Default expiration
        ExpiresDefault "access plus 1 month"

        # HTML - no cache (for PWA updates)
        ExpiresByType text/html "access plus 0 seconds"

        # JavaScript - 1 week (service worker needs frequent checks)
        ExpiresByType application/javascript "access plus 1 week"
        ExpiresByType text/javascript "access plus 1 week"

        # CSS - 1 week
        ExpiresByType text/css "access plus 1 week"

        # Images - 1 month
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/webp "access plus 1 month"
        ExpiresByType image/svg+xml "access plus 1 month"
        ExpiresByType image/x-icon "access plus 1 month"

        # Fonts - 1 year (they rarely change)
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"

        # JSON - no cache (API responses)
        ExpiresByType application/json "access plus 0 seconds"

        # Manifest - 1 day
        ExpiresByType application/manifest+json "access plus 1 day"
    </IfModule>

    # Service Worker specific headers
    <FilesMatch "sw\.js$">
        <IfModule mod_headers.c>
            # Service worker should not be cached
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </IfModule>
    </FilesMatch>

    # =========================================================================
    # Compression
    # =========================================================================

    <IfModule mod_deflate.c>
        # Compress HTML, CSS, JavaScript, Text, XML and fonts
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE application/manifest+json
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
        AddOutputFilterByType DEFLATE application/x-font
        AddOutputFilterByType DEFLATE application/x-font-opentype
        AddOutputFilterByType DEFLATE application/x-font-otf
        AddOutputFilterByType DEFLATE application/x-font-truetype
        AddOutputFilterByType DEFLATE application/x-font-ttf
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE font/opentype
        AddOutputFilterByType DEFLATE font/otf
        AddOutputFilterByType DEFLATE font/ttf
        AddOutputFilterByType DEFLATE image/svg+xml
        AddOutputFilterByType DEFLATE image/x-icon
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/xml

        # Remove browser bugs
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        Header append Vary User-Agent
    </IfModule>

    # =========================================================================
    # Protect Sensitive Files
    # =========================================================================

    # Block access to hidden files and directories
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # Block access to config and data directories (shouldn't be in public anyway)
    <DirectoryMatch "(config|data|src|templates|tests|vendor)">
        Require all denied
    </DirectoryMatch>

    # Block access to specific file types
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|bak|swp)$">
        Require all denied
    </FilesMatch>

    # =========================================================================
    # Logging
    # =========================================================================

    ErrorLog ${APACHE_LOG_DIR}/portal-error.log
    CustomLog ${APACHE_LOG_DIR}/portal-access.log combined

    # Log level (adjust for production)
    LogLevel warn

    # =========================================================================
    # PHP Configuration (if using mod_php)
    # =========================================================================

    <IfModule mod_php.c>
        php_flag display_errors off
        php_flag log_errors on
        php_value error_log /var/www/portal/data/logs/php-error.log
        php_value upload_max_filesize 10M
        php_value post_max_size 10M
        php_value max_execution_time 60
        php_value memory_limit 128M
    </IfModule>

    # =========================================================================
    # PHP-FPM Configuration (if using PHP-FPM)
    # =========================================================================

    <IfModule proxy_fcgi_module>
        # Adjust the socket path based on your PHP version
        <FilesMatch \.php$>
            SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </IfModule>

</VirtualHost>

# ============================================================================
# OCSP Stapling Cache (place outside of VirtualHost)
# ============================================================================

SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
